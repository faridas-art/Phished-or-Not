<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Defense</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styling for the URL tooltip */
        #url-tooltip {
            position: fixed;
            background-color: #1f2937;
            color: #ffffff;
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        
        /* Loading spinner CSS */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* Indigo color for spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Firebase Configuration Script - Must come BEFORE the game script -->
    <script>
        // Expose your Firebase configuration to the game script
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCQ22h4DxNd8NQm1dyJpdh-sHADu70f3YQ",
            authDomain: "phish-or-not-project.firebaseapp.com",
            projectId: "phish-or-not-project",
            storageBucket: "phish-or-not-project.firebasestorage.app",
            messagingSenderId: "455143280251",
            appId: "1:455143280251:web:3d7dd344688b1c1c2edcde",
            measurementId: "G-CF68SPNSJM"
        });
        
        // Set your app identifier
        window.__app_id = "phishing-defense-game";
        
        console.log("Firebase configuration loaded:", window.__firebase_config);
    </script>

    <!-- Main Game Container -->
    <div id="game-container" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-4xl flex flex-col items-center justify-center transition-all duration-300 min-h-[90vh] md:min-h-[80vh] relative">
        
        <!-- Innovatech Logo -->
        <div class="absolute top-4 left-4 p-2">
            <svg class="h-8 w-8 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM12 4.09L19.98 8.44V15.56L12 19.91L4.02 15.56V8.44L12 4.09ZM12 7.5L8.5 9.5V14.5L12 16.5L15.5 14.5V9.5L12 7.5Z"/>
                <text x="12" y="15" font-family="Arial" font-size="8" font-weight="bold" text-anchor="middle" fill="#ffffff">I</text>
            </svg>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="p-8 text-center">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">Phishing Defense</h1>
            
            <div id="auth-status" class="flex flex-col items-center justify-center mb-6">
                <div id="loading-spinner" class="loader mb-2"></div>
                <p id="loading-message" class="text-gray-500">Checking connection...</p>
                <p id="user-info" class="text-xs text-gray-500 mt-2 hidden"></p>
            </div>

            <p id="game-status" class="text-center text-gray-600 mb-4">Enter your nickname to start.</p>
            <input type="text" id="nickname-input" placeholder="Your Nickname" class="w-full max-w-xs px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4 text-center">
            <button id="start-game-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300 disabled:opacity-50" disabled>
                Start Game
            </button>
        </div>
        
        <!-- Game View -->
        <div id="game-view" class="w-full h-full flex flex-col p-6 hidden">
            <!-- Player Nickname Header -->
            <div id="player-nickname-header" class="text-lg font-semibold text-gray-700 mb-4 hidden"></div>
            
            <div id="email-content" class="bg-white rounded-lg p-6 shadow-md border border-gray-200 flex-grow overflow-y-auto min-h-[500px] flex flex-col justify-center items-center">
                <!-- Email content will be rendered here -->
            </div>
            
            <!-- Score & Progress Display -->
            <div id="score-display" class="mt-4 hidden">
                <div class="flex items-center justify-between text-gray-600 mb-1">
                    <span id="score-text" class="font-medium text-lg">Progress: 1/5</span>
                    <span id="player-score" class="font-bold text-gray-800 text-xl">0/5</span>
                </div>
            </div>
        </div>

        <!-- Feedback Popup -->
        <div id="feedback-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 id="feedback-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
                <p id="feedback-message" class="text-gray-600 mb-6"></p>
                <button id="next-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Next Email
                </button>
            </div>
        </div>

        <!-- End Game Scores Popup -->
        <div id="end-game-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Game Over!</h3>
                <p id="end-game-message" class="text-gray-600 text-lg mb-6"></p>
                <h4 class="text-xl font-semibold text-gray-800 mt-6 mb-4">Scores</h4>
                <ul id="leaderboard" class="space-y-3">
                    <!-- Scores items will be rendered here by JS -->
                </ul>
                <button id="play-again-btn" class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Play More
                </button>
                <button id="quit-game-btn" class="mt-4 w-full px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-400 transition-colors duration-300">
                    That's it for now
                </button>
            </div>
        </div>
        
        <!-- Thank You Page -->
        <div id="thank-you-screen" class="p-8 text-center hidden">
            <h1 id="thank-you-title" class="text-5xl font-bold text-gray-800 mb-4"></h1>
            <p id="thank-you-message" class="text-xl text-gray-500 mb-8"></p>
            <button id="thank-you-play-again-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                Play More
            </button>
        </div>
    </div>

    <!-- URL Tooltip to show on link hover -->
    <div id="url-tooltip" class="hidden"></div>

    <script type="module">
        // --- Configuration Check ---
        console.log("Starting Firebase initialization...");
        console.log("Available config:", !!window.__firebase_config);
        console.log("Available app_id:", !!window.__app_id);
        
        // Check for required configuration variables
        const requiredVars = ['__firebase_config', '__app_id'];
        const missingVars = requiredVars.filter(varName => typeof window[varName] === 'undefined' || window[varName] === '');
        
        if (missingVars.length > 0) {
            console.warn(`Missing configuration variables: ${missingVars.join(', ')}`);
            console.log("Running in offline mode - scores will not be saved");
            initializeOfflineMode();
        } else {
            console.log("Configuration found, attempting Firebase connection...");
            initializeFirebaseMode();
        }

        // --- Firebase Mode ---
        async function initializeFirebaseMode() {
            try {
                console.log("Loading Firebase modules...");
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { 
                    getAuth, 
                    signInAnonymously, 
                    signInWithCustomToken, 
                    onAuthStateChanged 
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { 
                    getFirestore, 
                    doc, 
                    getDoc, 
                    setDoc, 
                    onSnapshot, 
                    collection, 
                    query
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                let db, auth, userId = null;
                let isFirebaseReady = false;
                let isAuthListenerInitialized = false;

                console.log("Firebase modules loaded successfully");

                // Parse configuration
                let firebaseConfig;
                try {
                    firebaseConfig = typeof window.__firebase_config === 'string' ? 
                        JSON.parse(window.__firebase_config) : window.__firebase_config;
                    console.log("Firebase config parsed successfully");
                } catch (e) {
                    console.error("Failed to parse Firebase config:", e);
                    throw new Error("Invalid Firebase Configuration");
                }

                console.log("Initializing Firebase app...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                console.log("Firebase app initialized successfully");

                const initialAuthToken = window.__initial_auth_token || null;

                // Set up authentication listener
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state changed:", user ? `User signed in: ${user.uid}` : 'No user');
                    
                    if (!user) {
                        console.log("Attempting authentication...");
                        try {
                            if (initialAuthToken) {
                                console.log("Trying custom token auth...");
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Custom token sign-in successful");
                            } else {
                                console.log("Trying anonymous auth...");
                                await signInAnonymously(auth);
                                console.log("Anonymous sign-in successful");
                            }
                        } catch (e) {
                            console.error("Authentication failed:", e);
                            throw e;
                        }
                        return;
                    }
                    
                    if (user && !isAuthListenerInitialized) {
                        console.log("Initializing game with authenticated user");
                        isAuthListenerInitialized = true;
                        userId = user.uid;

                        await loadPlayerData(userId, db);
                        isFirebaseReady = true;
                        listenForScores(db);
                        
                        updateUI('firebase', userId);
                    }
                });

                // Firebase-specific functions
                async function loadPlayerData(uid, database) {
                    console.log("Loading player data for:", uid);
                    if (!database || !uid) return;
                    const appId = window.__app_id || 'default-app-id';
                    
                    const playerDocRef = doc(database, `artifacts/${appId}/users/${uid}/player_profile`, 'score_document');
                    
                    try {
                        const playerDoc = await getDoc(playerDocRef);
                        if (playerDoc.exists()) {
                            const data = playerDoc.data();
                            gameState.score = data.score || 0;
                            gameState.player.name = data.nickname || "Player";
                            
                            document.getElementById('nickname-input').value = gameState.player.name;
                            document.getElementById('game-status').innerHTML = `Welcome back, <strong>${gameState.player.name}</strong>! Your total score is ${gameState.score}.`;
                            console.log("Player data loaded from Firestore:", gameState.player.name, gameState.score);
                        } else {
                            gameState.score = 0;
                            gameState.player.name = "";
                            document.getElementById('game-status').textContent = "Enter your nickname to start.";
                            console.log("No existing player data found");
                        }
                    } catch (e) {
                        console.error("Error loading player data:", e);
                    }
                }

                function listenForScores(database) {
                    console.log("Setting up leaderboard listener...");
                    if (!database) return;
                    
                    const appId = window.__app_id || 'default-app-id';
                    const scoresColRef = collection(database, `artifacts/${appId}/public/data/leaderboard_scores`);
                    const q = query(scoresColRef);

                    onSnapshot(q, (snapshot) => {
                        const scores = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            scores.push({
                                id: doc.id,
                                name: data.nickname,
                                score: data.score
                            });
                        });
                        
                        scores.sort((a, b) => b.score - a.score);
                        gameState.leaderboardScores = scores;
                        console.log(`Leaderboard updated: ${scores.length} scores`);
                        
                        if (document.getElementById('end-game-popup').classList.contains('active-modal')) {
                            renderLeaderboard(scores);
                        }
                    }, (error) => {
                        console.error("Error listening to leaderboard:", error);
                    });
                }

                // Expose Firebase functions to global scope
                window.saveScore = async function() {
                    console.log("Saving score to Firebase...");
                    if (!isFirebaseReady || !userId) {
                        console.warn("Firebase not ready. Score not saved.");
                        return;
                    }
                    
                    const appId = window.__app_id || 'default-app-id';
                    const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/player_profile`, 'score_document');
                    
                    const newScoreData = {
                        nickname: gameState.player.name,
                        score: gameState.score,
                        lastPlayed: new Date().toISOString()
                    };

                    try {
                        await setDoc(playerDocRef, newScoreData, { merge: true });
                        console.log("Score saved to private profile");

                        // Update public leaderboard
                        const publicDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard_scores`, userId);
                        const publicData = {
                            nickname: gameState.player.name,
                            score: gameState.score,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        await setDoc(publicDocRef, publicData, { merge: true });
                        console.log("Public leaderboard updated");
                    } catch (e) {
                        console.error("Error saving score:", e);
                    }
                };

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                console.log("Falling back to offline mode");
                initializeOfflineMode();
            }
        }

        // --- Offline Mode ---
        function initializeOfflineMode() {
            console.log("Initializing offline mode");
            
            // Load from localStorage if available
            const savedData = localStorage.getItem('phishing-defense-data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    gameState.score = parsed.score || 0;
                    gameState.player.name = parsed.name || "";
                    gameState.leaderboardScores = parsed.leaderboard || [];
                    console.log("Loaded offline data:", parsed);
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                }
            }

            // Mock save function for offline mode
            window.saveScore = async function() {
                console.log("Saving score locally");
                const dataToSave = {
                    score: gameState.score,
                    name: gameState.player.name,
                    leaderboard: gameState.leaderboardScores,
                    lastPlayed: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem('phishing-defense-data', JSON.stringify(dataToSave));
                    
                    // Update local leaderboard
                    const existingPlayerIndex = gameState.leaderboardScores.findIndex(p => p.name === gameState.player.name);
                    if (existingPlayerIndex >= 0) {
                        gameState.leaderboardScores[existingPlayerIndex].score = gameState.score;
                    } else {
                        gameState.leaderboardScores.push({
                            id: 'local-' + Date.now(),
                            name: gameState.player.name,
                            score: gameState.score
                        });
                    }
                    
                    gameState.leaderboardScores.sort((a, b) => b.score - a.score);
                    console.log("Score saved locally");
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                }
            };

            updateUI('offline');
        }

        // --- UI Update Function ---
        function updateUI(mode, userId = null) {
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadingMessage = document.getElementById('loading-message');
            const userInfoEl = document.getElementById('user-info');
            const startGameBtn = document.getElementById('start-game-btn');

            loadingSpinner.classList.add('hidden');
            
            if (mode === 'firebase') {
                loadingMessage.textContent = "Connected!";
                loadingMessage.className = "text-green-600";
               // userInfoEl.textContent = `User ID: ${userId}`;
                userInfoEl.classList.remove('hidden');
            } else {
                loadingMessage.textContent = "Playing offline!";
                loadingMessage.className = "text-yellow-600";
               // userInfoEl.textContent = "Offline Mode";
                userInfoEl.classList.remove('hidden');
            }
            
            startGameBtn.disabled = false;
        }

        // --- Game State ---
        const gameState = {
            currentEmail: null,
            score: 0,
            sessionScore: 0,
            currentEmailIndex: 0,
            emails: [],
            player: { name: "Player" },
            leaderboardScores: [],
            
            scenarios: [
                {
                    id: 1,
                    sender: "Netflix Support <noreply@netflix-update.co>",
                    subject: "Your Netflix account has been suspended",
                    body: "We have temporarily suspended your account due to an issue with your billing information. Please click the link below to verify your details and reactivate your account. <br><br> <a href='http://netflix-login.info/update' class='text-indigo-600 hover:underline'>Click here to update your account</a>",
                    isPhishing: true,
                    redFlags: ["Sender's email domain (@netflix-update.co) is incorrect.","Urgent and threatening language is a common tactic.","The link points to a non-Netflix URL."]
                },
                {
                    id: 2,
                    sender: "Amazon <security@amazon.com>",
                    subject: "Order Confirmation: Your recent purchase",
                    body: "Dear [User Name], <br><br> Thank you for your recent purchase. Your order #113-456789-012345 has been confirmed and will be shipped shortly. You can track your order here: <a href='https://amazon.com/tracking' class='text-indigo-600 hover:underline'>Track Package</a>. <br><br> Sincerely, <br>The Amazon Team",
                    isPhishing: false,
                    redFlags: ["Sender's domain is correct.","No sense of urgency or threat.","Link points to the correct domain."]
                },
                {
                    id: 3,
                    sender: "HR Department <HR-announcements@innovatech-internal.com>",
                    subject: "Mandatory System Update",
                    body: "All employees must update their system credentials via the link below to comply with new security protocols. Failure to do so will result in a temporary suspension of access. <br><br> <a href='http://credentials-update.co/login' class='text-indigo-600 hover:underline'>Update Credentials Now</a>",
                    isPhishing: true,
                    redFlags: ["Urgent, high-pressure language to create panic.","The email asks for credentials, which a legitimate IT department would not do.","The email domain is incorrect (it should be @innovatech.com)."]
                },
                {
                    id: 4,
                    sender: "IT Support <support@innovatech.com>",
                    subject: "New IT Portal for Support Requests",
                    body: "Hi team, <br><br> We are rolling out a new IT support portal to streamline requests. You can now submit tickets directly at our new portal. Please bookmark the link for future use: <br><br> <a href='https://portal.innovatech.com' class='text-indigo-600 hover:underline'>https://portal.innovatech.com</a>",
                    isPhishing: false,
                    redFlags: ["Sender's email and tone are appropriate for an internal notice.","The link points to a plausible internal sub-domain.","No sudden urgent requests for sensitive data."]
                },
                {
                    id: 5,
                    sender: "Accounts Payable <payments@invoicesystem.co>",
                    subject: "URGENT Invoice from Supplier",
                    body: "Attached is an invoice for a recent order. Please transfer payment within 24 hours to the new bank account number listed in the attached document to avoid late fees. <br><br> Attachment: <a href='http://invoicesystem.com/payment' class='text-indigo-600 hover:underline'>Invoice_#3459.pdf</a>",
                    isPhishing: true,
                    redFlags: ["Extreme urgency and pressure for financial action.","Request to change payment details unexpectedly.","Sender's email address is from a generic, suspicious domain."]
                }
            ],
        };

        // --- Game Logic Functions ---
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        async function startGame() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (nickname === "") {
                document.getElementById('game-status').textContent = "Please enter a nickname to start.";
                return;
            }
            gameState.player.name = nickname;
            
            document.getElementById('player-nickname-header').textContent = `Hello, ${gameState.player.name}! Defend the inbox.`;
            document.getElementById('player-nickname-header').classList.remove('hidden');

            gameState.sessionScore = 0;
            gameState.currentEmailIndex = 0;
            gameState.emails = shuffleArray(gameState.scenarios);

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('thank-you-screen').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('score-display').classList.remove('hidden');
            
            renderEmail(gameState.emails[gameState.currentEmailIndex]);
            updateSessionScoreDisplay();
        }

        function renderEmail(email) {
            const emailContent = document.getElementById('email-content');
            emailContent.classList.remove('justify-center', 'items-center');

            const escapedSender = email.sender
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            emailContent.innerHTML = `
                <div class="mb-4 overflow-x-auto">
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-1">${email.subject}</h2>
                    <p class="text-gray-500 text-sm">From: <span class="font-medium text-gray-700">${escapedSender}</span></p>
                </div>
                <div class="prose max-w-none text-gray-700 mb-6">
                    ${email.body}
                </div>
                <div id="action-buttons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                    <button id="safe-btn" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-colors duration-300">
                        ✓ Safe
                    </button>
                    <button id="phish-btn" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-lg hover:bg-red-600 transition-colors duration-300">
                        ⚠ Spam
                    </button>
                </div>
            `;

            document.getElementById('safe-btn').addEventListener('click', () => handleAnswer(false, email));
            document.getElementById('phish-btn').addEventListener('click', () => handleAnswer(true, email));
            
            const links = emailContent.querySelectorAll('a');
            const urlTooltip = document.getElementById('url-tooltip');
            
            links.forEach(link => {
                link.addEventListener('mouseover', (e) => {
                    const href = e.target.getAttribute('href');
                    if (href) {
                        urlTooltip.textContent = href;
                        urlTooltip.style.top = `${e.clientY + 15}px`;
                        urlTooltip.style.left = `${e.clientX + 15}px`;
                        urlTooltip.classList.remove('hidden');
                    }
                });
                link.addEventListener('mouseout', () => {
                    urlTooltip.classList.add('hidden');
                });
            });
        }

        function handleAnswer(isUserPhish, email) {
            const isCorrect = (isUserPhish === email.isPhishing);
            const scoreChange = isCorrect ? 1 : 0;
            
            gameState.sessionScore += scoreChange;
            updateSessionScoreDisplay();
            showFeedback(isCorrect, email);

            document.getElementById('safe-btn').disabled = true;
            document.getElementById('phish-btn').disabled = true;
        }

        function showFeedback(isCorrect, email) {
            const title = isCorrect ? "Correct!" : "Oops, Not Quite.";
            let message = "";
            const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;

            if (isCorrect) {
                message = email.isPhishing
                    ? `<strong>Great job!</strong> You correctly spotted the scam.`
                    : `<strong>Excellent!</strong> This was a safe and legitimate message.`;
            } else {
                message = email.isPhishing
                    ? "This was a phishing email. You should have reported it."
                    : "This was a safe email. Not every urgent email is a scam!";
                
                message += "<div class='text-left mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-700'><h4 class='font-bold mb-2'>Analysis:</h4><ul class='list-disc list-inside space-y-1'>" + email.redFlags.map(flag => `<li>${flag}</li>`).join('') + "</ul></div>";
            }

            document.getElementById('next-btn').textContent = isLastEmail ? "View Final Score" : "Next Email";
            document.getElementById('feedback-title').textContent = title;
            document.getElementById('feedback-message').innerHTML = message;
            document.getElementById('feedback-popup').classList.add('active-modal');
            document.getElementById('feedback-popup').classList.remove('hidden');
        }

        function nextEmail() {
            document.getElementById('feedback-popup').classList.remove('active-modal');
            document.getElementById('feedback-popup').classList.add('hidden');
            gameState.currentEmailIndex++;
            
            if (gameState.currentEmailIndex < gameState.emails.length) {
                renderEmail(gameState.emails[gameState.currentEmailIndex]);
                updateSessionScoreDisplay();
            } else {
                endGame();
            }
        }
        
        async function endGame() {
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('end-game-popup').classList.add('active-modal');
            document.getElementById('end-game-popup').classList.remove('hidden');
            
            gameState.score += gameState.sessionScore;
            
            if (window.saveScore) {
                await window.saveScore();
            }

            const sessionScore = gameState.sessionScore;
            const totalEmails = gameState.emails.length;
            
            let finalMessage = "";
            if (sessionScore === totalEmails) {
                finalMessage = `Perfect defense, ${gameState.player.name}!`;
            } else if (sessionScore >= totalEmails * 0.8) {
                finalMessage = `Strong defense, ${gameState.player.name}!`;
            } else {
                finalMessage = `Good effort, ${gameState.player.name}!`;
            }

            document.getElementById('end-game-message').innerHTML = finalMessage;
            renderLeaderboard(gameState.leaderboardScores);
        }

        function showThankYouScreen() {
            document.getElementById('end-game-popup').classList.remove('active-modal');
            document.getElementById('end-game-popup').classList.add('hidden');
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('thank-you-screen').classList.remove('hidden');

            const score = gameState.score;
            const name = gameState.player.name;
            let title = `Thanks for Playing, ${name}!`;
            let message = `Your total career score is <strong>${score}</strong>. Keep building that defense!`;

            if (score > 15) {
                title = `Cybersecurity Champion, ${name}!`;
            } else if (score > 5) {
                title = `Well Done, ${name}!`;
            }

            document.getElementById('thank-you-title').textContent = title;
            document.getElementById('thank-you-message').innerHTML = message;
        }
        
        function updateSessionScoreDisplay() {
            const totalEmails = gameState.emails.length;
            const currentEmailNumber = gameState.currentEmailIndex + 1;
            
            document.getElementById('score-text').textContent = `Email ${currentEmailNumber} of ${totalEmails}`;
            document.getElementById('player-score').textContent = `${gameState.sessionScore} / ${totalEmails}`;
        }

        function renderLeaderboard(scores) {
            const scoresListEl = document.getElementById('leaderboard');
            scoresListEl.innerHTML = '';
            
            if (scores.length === 0) {
                scoresListEl.innerHTML = '<li class="text-gray-500">No scores yet. Be the first!</li>';
                return;
            }

            scores.slice(0, 10).forEach(item => {
                const isPlayer = item.name === gameState.player.name;
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between items-center text-gray-700 px-4 py-2 rounded-lg ${isPlayer ? 'bg-indigo-100 font-semibold border-2 border-indigo-400' : ''}`;
                listItem.innerHTML = `
                    <span class="truncate">${item.name} ${isPlayer ? '(You)' : ''}</span>
                    <span class="font-bold text-lg">${item.score}</span>
                `;
                scoresListEl.appendChild(listItem);
            });
        }
        
        // --- Event Listeners ---
        document.getElementById('start-game-btn').addEventListener('click', startGame);

        document.getElementById('next-btn').addEventListener('click', () => {
             const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;
             if (isLastEmail) {
                document.getElementById('feedback-popup').classList.remove('active-modal');
                document.getElementById('feedback-popup').classList.add('hidden');
                endGame();
             } else {
                nextEmail(); 
             }
        });

        document.getElementById('play-again-btn').addEventListener('click', () => {
            document.getElementById('end-game-popup').classList.remove('active-modal');
            document.getElementById('end-game-popup').classList.add('hidden');
            startGame();
        });
        
        document.getElementById('quit-game-btn').addEventListener('click', showThankYouScreen);
        
        document.getElementById('thank-you-play-again-btn').addEventListener('click', () => {
            startGame();
        });

    </script>
</body>
</html>