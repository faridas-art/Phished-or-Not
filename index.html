<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Defense</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styling for the URL tooltip */
        #url-tooltip {
            position: fixed;
            background-color: #1f2937;
            color: #ffffff;
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        
        /* Loading spinner CSS */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* Indigo color for spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main Game Container -->
    <div id="game-container" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-4xl flex flex-col items-center justify-center transition-all duration-300 min-h-[90vh] md:min-h-[80vh] relative">
        
        <!-- Innovatech Logo -->
        <div class="absolute top-4 left-4 p-2">
            <svg class="h-8 w-8 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM12 4.09L19.98 8.44V15.56L12 19.91L4.02 15.56V8.44L12 4.09ZM12 7.5L8.5 9.5V14.5L12 16.5L15.5 14.5V9.5L12 7.5Z"/>
                <text x="12" y="15" font-family="Arial" font-size="8" font-weight="bold" text-anchor="middle" fill="#ffffff">I</text>
            </svg>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="p-8 text-center">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">Phishing Defense</h1>
            
            <div id="auth-status" class="flex flex-col items-center justify-center mb-6">
                <div id="loading-spinner" class="loader mb-2"></div>
                <p id="loading-message" class="text-gray-500">Connecting to database...</p>
                <p id="user-info" class="text-xs text-gray-500 mt-2 hidden"></p>
            </div>

            <p id="game-status" class="text-center text-gray-600 mb-4">Enter your nickname to start.</p>
            <input type="text" id="nickname-input" placeholder="Your Nickname" class="w-full max-w-xs px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4 text-center">
            <button id="start-game-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300 disabled:opacity-50" disabled>
                Start Game
            </button>
        </div>
        
        <!-- Game View -->
        <div id="game-view" class="w-full h-full flex flex-col p-6 hidden">
            <!-- Player Nickname Header -->
            <div id="player-nickname-header" class="text-lg font-semibold text-gray-700 mb-4 hidden"></div>
            
            <div id="email-content" class="bg-white rounded-lg p-6 shadow-md border border-gray-200 flex-grow overflow-y-auto min-h-[500px] flex flex-col justify-center items-center">
                <!-- Email content will be rendered here -->
            </div>
            
            <!-- Score & Progress Display -->
            <div id="score-display" class="mt-4 hidden">
                <div class="flex items-center justify-between text-gray-600 mb-1">
                    <span id="score-text" class="font-medium text-lg">Progress: 1/5</span>
                    <span id="player-score" class="font-bold text-gray-800 text-xl">0/5</span>
                </div>
            </div>
        </div>

        <!-- Feedback Popup -->
        <div id="feedback-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 id="feedback-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
                <p id="feedback-message" class="text-gray-600 mb-6"></p>
                <button id="next-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Next Email
                </button>
            </div>
        </div>

        <!-- End Game Scores Popup -->
        <div id="end-game-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Game Over!</h3>
                <p id="end-game-message" class="text-gray-600 text-lg mb-6"></p>
                <h4 class="text-xl font-semibold text-gray-800 mt-6 mb-4">Scores</h4>
                <ul id="leaderboard" class="space-y-3">
                    <!-- Scores items will be rendered here by JS -->
                </ul>
                <button id="play-again-btn" class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Play More
                </button>
                <button id="quit-game-btn" class="mt-4 w-full px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-400 transition-colors duration-300">
                    That's it for now
                </button>
            </div>
        </div>
        
        <!-- Thank You Page -->
        <div id="thank-you-screen" class="p-8 text-center hidden">
            <h1 id="thank-you-title" class="text-5xl font-bold text-gray-800 mb-4"></h1>
            <p id="thank-you-message" class="text-xl text-gray-500 mb-8"></p>
            <button id="thank-you-play-again-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                Play More
            </button>
        </div>
    </div>

    <!-- URL Tooltip to show on link hover -->
    <div id="url-tooltip" class="hidden"></div>

    <!-- Firebase Imports and Game Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- Firebase Globals and State ---
        let db;
        let auth;
        let userId = null;
        let isFirebaseReady = false;
        let isAuthListenerInitialized = false; // Flag to ensure initialization runs only once
        
        // --- Game State (Now depends on Firebase) ---
        const gameState = {
            currentEmail: null,
            score: 0, // Total career score from Firestore
            sessionScore: 0, // Score for the current fixed session
            currentEmailIndex: 0, 
            emails: [],
            player: { name: "Player" },
            leaderboardScores: [], // Real-time scores fetched from Firestore
            
            // Pre-defined set of phishing scenarios and safe emails (STATIC DATA)
            scenarios: [
                {
                    id: 1,
                    sender: "Netflix Support <noreply@netflix-update.co>",
                    subject: "Your Netflix account has been suspended",
                    body: "We have temporarily suspended your account due to an issue with your billing information. Please click the link below to verify your details and reactivate your account. <br><br> <a href='http://netflix-login.info/update' class='text-indigo-600 hover:underline'>Click here to update your account</a>",
                    isPhishing: true,
                    redFlags: ["Sender's email domain (@netflix-update.co) is incorrect.","Urgent and threatening language is a common tactic.","The link points to a non-Netflix URL."]
                },
                {
                    id: 2,
                    sender: "Amazon <security@amazon.com>",
                    subject: "Order Confirmation: Your recent purchase",
                    body: "Dear [User Name], <br><br> Thank you for your recent purchase. Your order #113-456789-012345 has been confirmed and will be shipped shortly. You can track your order here: <a href='https://amazon.com/tracking' class='text-indigo-600 hover:underline'>Track Package</a>. <br><br> Sincerely, <br>The Amazon Team",
                    isPhishing: false,
                    redFlags: ["Sender's domain is correct.","No sense of urgency or threat.","Link points to the correct domain."]
                },
                {
                    id: 3,
                    sender: "HR Department <HR-announcements@innovatech-internal.com>",
                    subject: "Mandatory System Update",
                    body: "All employees must update their system credentials via the link below to comply with new security protocols. Failure to do so will result in a temporary suspension of access. <br><br> <a href='http://credentials-update.co/login' class='text-indigo-600 hover:underline'>Update Credentials Now</a>",
                    isPhishing: true,
                    redFlags: ["Urgent, high-pressure language to create panic.","The email asks for credentials, which a legitimate IT department would not do.","The email domain is incorrect (it should be @innovatech.com)."]
                },
                {
                    id: 4,
                    sender: "IT Support <support@innovatech.com>",
                    subject: "New IT Portal for Support Requests",
                    body: "Hi team, <br><br> We are rolling out a new IT support portal to streamline requests. You can now submit tickets directly at our new portal. Please bookmark the link for future use: <br><br> <a href='https://portal.innovatech.com' class='text-indigo-600 hover:underline'>https://portal.innovatech.com</a>",
                    isPhishing: false,
                    redFlags: ["Sender's email and tone are appropriate for an internal notice.","The link points to a plausible internal sub-domain.","No sudden urgent requests for sensitive data."]
                },
                {
                    id: 5,
                    sender: "Accounts Payable <payments@invoicesystem.co>",
                    subject: "URGENT Invoice from Supplier",
                    body: "Attached is an invoice for a recent order. Please transfer payment within 24 hours to the new bank account number listed in the attached document to avoid late fees. <br><br> Attachment: <a href='http://invoicesystem.com/payment' class='text-indigo-600 hover:underline'>Invoice_#3459.pdf</a>",
                    isPhishing: true,
                    redFlags: ["Extreme urgency and pressure for financial action.","Request to change payment details unexpectedly.","Sender's email address is from a generic, suspicious domain."]
                }
            ],
        };

        // --- DOM elements ---
        const startScreen = document.getElementById('start-screen');
        const nicknameInput = document.getElementById('nickname-input');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameStatus = document.getElementById('game-status');
        const gameView = document.getElementById('game-view');
        const emailContent = document.getElementById('email-content');
        const playerScoreEl = document.getElementById('player-score');
        const scoreTextEl = document.getElementById('score-text');
        const scoreDisplayEl = document.getElementById('score-display');
        const feedbackPopup = document.getElementById('feedback-popup');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const endGamePopup = document.getElementById('end-game-popup');
        const endGameMessageEl = document.getElementById('end-game-message');
        const scoresListEl = document.getElementById('leaderboard');
        const playAgainBtn = document.getElementById('play-again-btn');
        const quitGameBtn = document.getElementById('quit-game-btn');
        const thankYouScreen = document.getElementById('thank-you-screen');
        const thankYouPlayAgainBtn = document.getElementById('thank-you-play-again-btn');
        const urlTooltip = document.getElementById('url-tooltip');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingMessage = document.getElementById('loading-message');
        const userInfoEl = document.getElementById('user-info');
        const playerNicknameHeaderEl = document.getElementById('player-nickname-header'); 
        
        // --- Utility Functions ---
        
        // Utility function to shuffle array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Firebase/Data Functions ---

        async function initializeFirebase() {
            try {
                // Set Firestore logging to debug mode
                setLogLevel('Debug'); 
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig;

                // --- Robust check for config parsing error ---
                if (typeof __firebase_config === 'string' && __firebase_config.length > 0) {
                     try {
                        firebaseConfig = JSON.parse(__firebase_config);
                     } catch (e) {
                         console.error("Failed to parse __firebase_config:", e);
                         throw new Error("Invalid Firebase Configuration.");
                     }
                } else {
                     throw new Error("Missing or empty Firebase Configuration string.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


                // 1. Set up the primary auth listener and initialize app state once ready
                // This listener will be the SOLE entry point for game initialization, preventing race conditions.
                onAuthStateChanged(auth, async (user) => {
                    
                    // --- Step 1: Authentication Handler ---
                    if (!user) {
                        // Case A: No user yet. Try to authenticate.
                        
                        if (initialAuthToken) {
                            // 1. Try custom token sign-in (if token is available)
                            console.log("No user found. Attempting sign-in with custom token.");
                            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Custom token sign-in failed. Falling back to anonymous.", e);
                                // If token fails, fall back to anonymous sign-in
                                signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                            });
                        } else {
                            // 2. Fall back to anonymous sign-in
                            console.log("No token or user found. Signing in anonymously.");
                            await signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                        }
                        
                        return; // Exit until the next auth state change (when a user is created/signed in)
                    }
                    
                    // --- Step 2: Initialization Handler (User is now guaranteed to be authenticated) ---
                    if (user && !isAuthListenerInitialized) {
                        console.log("User authenticated. Initializing game state and data listeners.");
                        isAuthListenerInitialized = true;
                        userId = user.uid;

                        // Proceed with data loading and listeners only once auth is confirmed
                        await loadPlayerData(userId);
                        
                        isFirebaseReady = true;
                        listenForScores(appId); 
                        
                        // Update UI state
                        loadingSpinner.classList.add('hidden');
                        loadingMessage.textContent = "Ready to play!";
                        userInfoEl.textContent = `User ID: ${userId}`;
                        userInfoEl.classList.remove('hidden');
                        startGameBtn.disabled = false;
                    }
                });
                
            } catch (error) {
                // This catch block handles errors from the explicit checks above (e.g., bad config) 
                // and any general Firebase SDK initialization error.
                console.error("Firebase Initialization Error:", error.message || error);
                loadingSpinner.classList.add('hidden');
                loadingMessage.textContent = "Scores will not be saved.";
                startGameBtn.disabled = false; // Allow local play even if Firebase fails
            }
        }

        async function loadPlayerData(uid) {
            if (!db || !uid) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // CRITICAL: Using the PRIVATE path for the user's score/profile data
            const playerDocRef = doc(db, `artifacts/${appId}/users/${uid}/player_profile`, 'score_document');
            
            try {
                const playerDoc = await getDoc(playerDocRef);
                if (playerDoc.exists()) {
                    const data = playerDoc.data();
                    gameState.score = data.score || 0;
                    gameState.player.name = data.nickname || "Player";
                    
                    // Suggest/pre-fill nickname
                    nicknameInput.value = gameState.player.name;
                    gameStatus.innerHTML = `Welcome back, **${gameState.player.name}**! Your total score is ${gameState.score}.`;
                } else {
                    // New player
                    gameState.score = 0;
                    gameState.player.name = ""; // Allow new name entry
                    gameStatus.textContent = `Enter your nickname to start.`;
                }
            } catch (e) {
                console.error("Error loading player data:", e);
                // Keep playing even if load fails
            }
        }

        function listenForScores(appId) {
            if (!db) {
                console.warn("Database is not initialized. Cannot listen for scores.");
                return;
            }
            // This still uses the public path for the global leaderboard display
            const scoresColRef = collection(db, `artifacts/${appId}/public/data/leaderboard_scores`);
            
            // Query without limit to ensure all scores are fetched, mitigating potential query constraints
            const q = query(scoresColRef);

            // Setting up the real-time listener
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    scores.push({
                        id: doc.id,
                        name: data.nickname,
                        score: data.score
                    });
                });
                console.log(`Leaderboard updated. Total scores received: ${scores.length}`);
                
                // Sort the scores locally
                scores.sort((a, b) => b.score - a.score);
                gameState.leaderboardScores = scores;
                
                // If the game is over, re-render the leaderboard
                if (endGamePopup.classList.contains('active-modal')) {
                     renderLeaderboard(scores);
                }
            }, (error) => {
                // This is the error handler that was logging the permission error
                console.error("Error listening to leaderboard:", error);
            });
        }

        async function updatePublicLeaderboard() {
            if (!isFirebaseReady || !userId) return;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Public path for global leaderboard display (Read/Write for all authenticated users)
            const publicDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard_scores`, userId);
            
            console.log(`Attempting to update public leaderboard at path: artifacts/${appId}/public/data/leaderboard_scores/${userId}`);
            
            const publicData = {
                nickname: gameState.player.name,
                score: gameState.score, // Total career score
                lastUpdated: new Date().toISOString()
            };
            
            try {
                // Use setDoc to create or overwrite the document for the unique userId
                await setDoc(publicDocRef, publicData, { merge: true });
                console.log("Public leaderboard updated.");
            } catch (e) {
                console.error("Error updating public leaderboard:", e);
            }
        }

        async function saveScore() {
            if (!isFirebaseReady || !userId) {
                console.warn("Firebase not ready or user not authenticated. Score not saved.");
                return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // CRITICAL: Use the PRIVATE path for the user's score/profile data first
            const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/player_profile`, 'score_document');
            
            const newScoreData = {
                nickname: gameState.player.name,
                score: gameState.score, // Total career score
                lastPlayed: new Date().toISOString()
            };

            try {
                // 1. Save core data to secure private path
                await setDoc(playerDocRef, newScoreData, { merge: true });
                console.log("Score and Nickname saved successfully to private profile.");

                // 2. Update public leaderboard cache
                await updatePublicLeaderboard();

            } catch (e) {
                console.error("Error saving score to private profile:", e);
            }
        }

        function renderLeaderboard(scores) {
            scoresListEl.innerHTML = '';
            
            if (scores.length === 0) {
                scoresListEl.innerHTML = '<li class="text-gray-500">No scores yet. Be the first!</li>';
                return;
            }

            scores.slice(0, 10).forEach(item => { // Show top 10
                const isPlayer = item.id === userId;
                const listItem = document.createElement('li');
                // Use indigo for the current player highlight
                listItem.className = `flex justify-between items-center text-gray-700 px-4 py-2 rounded-lg ${isPlayer ? 'bg-indigo-100 font-semibold border-2 border-indigo-400' : ''}`;
                listItem.innerHTML = `
                    <span class="truncate">${item.name} ${isPlayer ? '(You)' : ''}</span>
                    <span class="font-bold text-lg">${item.score}</span>
                `;
                scoresListEl.appendChild(listItem);
            });
        }
        
        // --- Game Logic Functions ---
        
        async function startGame() {
            const nickname = nicknameInput.value.trim();
            if (nickname === "") {
                gameStatus.textContent = "Please enter a nickname to start.";
                return;
            }
            gameState.player.name = nickname;
            
            // Set friendly nickname header in game view
            playerNicknameHeaderEl.textContent = `Hello, ${gameState.player.name}! Defend the inbox.`;
            playerNicknameHeaderEl.classList.remove('hidden');

            // Reset session-specific game state
            gameState.sessionScore = 0;
            gameState.currentEmailIndex = 0;
            gameState.emails = shuffleArray([...gameState.scenarios]); 

            startScreen.classList.add('hidden');
            thankYouScreen.classList.add('hidden');
            gameView.classList.remove('hidden');
            scoreDisplayEl.classList.remove('hidden');
            
            // Start rendering the first email
            renderEmail(gameState.emails[gameState.currentEmailIndex]);
            updateSessionScoreDisplay();
        }

        function renderEmail(email) {
            emailContent.classList.remove('justify-center', 'items-center');

            const escapedSender = email.sender
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            emailContent.innerHTML = `
                <div class="mb-4 overflow-x-auto">
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-1">${email.subject}</h2>
                    <p class="text-gray-500 text-sm" data-full-sender="${escapedSender}">From: <span class="font-medium text-gray-700">${escapedSender}</span></p>
                </div>
                <div class="prose max-w-none text-gray-700 mb-6">
                    ${email.body}
                </div>
                <div id="action-buttons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                    <button id="safe-btn" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-colors duration-300">
                        <i class="fas fa-check-circle mr-2"></i> Safe
                    </button>
                    <button id="phish-btn" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-lg hover:bg-red-600 transition-colors duration-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Spam
                    </button>
                </div>
            `;

            document.getElementById('safe-btn').addEventListener('click', () => handleAnswer(false, email));
            document.getElementById('phish-btn').addEventListener('click', () => handleAnswer(true, email));
            
            const links = emailContent.querySelectorAll('a');
            links.forEach(link => {
                link.addEventListener('mouseover', (e) => {
                    const href = e.target.getAttribute('href');
                    if (href) {
                        urlTooltip.textContent = href;
                        urlTooltip.style.top = `${e.clientY + 15}px`;
                        urlTooltip.style.left = `${e.clientX + 15}px`;
                        urlTooltip.classList.remove('hidden');
                    }
                });
                link.addEventListener('mouseout', () => {
                    urlTooltip.classList.add('hidden');
                });
            });
        }

        function handleAnswer(isUserPhish, email) {
            const isCorrect = (isUserPhish === email.isPhishing);
            const scoreChange = isCorrect ? 1 : 0;
            
            // Only update session score here
            gameState.sessionScore += scoreChange; 
            
            updateSessionScoreDisplay(); 
            showFeedback(isCorrect, email);

            document.getElementById('safe-btn').disabled = true;
            document.getElementById('phish-btn').disabled = true;
        }

        function showFeedback(isCorrect, email) {
            const title = isCorrect ? "Correct!" : "Oops, Not Quite.";
            let message = "";
            const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;

            if (isCorrect) {
                message = email.isPhishing
                    ? `**Great job!** You correctly spotted the scam.`
                    : `**Excellent!** This was a safe and legitimate message.`;
            } else {
                // If incorrect, provide the reason (the red flags)
                message = email.isPhishing
                    ? "This was a phishing email. You should have reported it."
                    : "This was a safe email. Not every urgent email is a scam!";
                
                // Add the analysis block ONLY when the user is incorrect
                message += "<div class='text-left mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-700'><h4 class='font-bold mb-2'>Analysis:</h4><ul class='list-disc list-inside space-y-1'>" + email.redFlags.map(flag => `<li>${flag}</li>`).join('') + "</ul></div>";
            }

            nextBtn.textContent = isLastEmail ? "View Final Score" : "Next Email";

            feedbackTitle.textContent = title;
            feedbackMessage.innerHTML = message;
            feedbackPopup.classList.add('active-modal');
            feedbackPopup.classList.remove('hidden');
        }

        function nextEmail() {
            feedbackPopup.classList.remove('active-modal');
            feedbackPopup.classList.add('hidden');
            gameState.currentEmailIndex++;
            if (gameState.currentEmailIndex < gameState.emails.length) {
                renderEmail(gameState.emails[gameState.currentEmailIndex]);
                updateSessionScoreDisplay();
            } else {
                endGame();
            }
        }
        
        async function endGame() {
            gameView.classList.add('hidden');
            endGamePopup.classList.add('active-modal');
            endGamePopup.classList.remove('hidden');
            
            // Update TOTAL career score
            gameState.score += gameState.sessionScore;
            
            // Save the new score
            await saveScore(); 

            const sessionScore = gameState.sessionScore;
            const totalEmails = gameState.emails.length;
            
            // Simplified, score-less message for end-game popup
            let finalMessage = "";

            if (sessionScore === totalEmails) {
                finalMessage = `Perfect defense, ${gameState.player.name}!`;
            } else if (sessionScore >= totalEmails * 0.8) {
                finalMessage = `Strong defense, ${gameState.player.name}!`;
            } else {
                finalMessage = `Good effort, ${gameState.player.name}!`;
            }

            endGameMessageEl.innerHTML = finalMessage;
            
            // Render the real-time scores fetched by the listener
            renderLeaderboard(gameState.leaderboardScores);
        }

        function showThankYouScreen() {
            endGamePopup.classList.remove('active-modal');
            endGamePopup.classList.add('hidden');
            gameView.classList.add('hidden'); 
            thankYouScreen.classList.remove('hidden');

            const score = gameState.score;
            const name = gameState.player.name;
            let title = `Thanks for Playing, ${name}!`;
           // let message = `Your total career score is **${score}**. Keep building that defense!`;

            if (score > 15) {
                title = `Cybersecurity Champion, ${name}!`;
            } else if (score > 5) {
                title = `Well Done, ${name}!`;
            }

            document.getElementById('thank-you-title').textContent = title;
            document.getElementById('thank-you-message').innerHTML = message;
        }
        
        function updateSessionScoreDisplay() {
            const totalEmails = gameState.emails.length;
            const currentEmailNumber = gameState.currentEmailIndex + 1;
            
            scoreTextEl.textContent = `Email ${currentEmailNumber} of ${totalEmails}`;
            playerScoreEl.textContent = `${gameState.sessionScore} / ${totalEmails}`;
        }
        
        // --- Event Listeners ---
        startGameBtn.addEventListener('click', startGame);

        nextBtn.addEventListener('click', () => {
             const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;

             if (isLastEmail) {
                feedbackPopup.classList.remove('active-modal');
                feedbackPopup.classList.add('hidden');
                endGame();
             } else {
                nextEmail(); 
             }
        });

        playAgainBtn.addEventListener('click', () => {
            endGamePopup.classList.remove('active-modal');
            endGamePopup.classList.add('hidden');
            // Re-load player data to get updated total score and name
            loadPlayerData(userId).then(startGame); 
        });
        
        quitGameBtn.addEventListener('click', showThankYouScreen);
        
        thankYouPlayAgainBtn.addEventListener('click', () => {
            startGame();
        });
        
        // Initialize Firebase on load
        initializeFirebase();

    </script>
</body>
</html>
