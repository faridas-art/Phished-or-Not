<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Defense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Styling for the URL tooltip */
        #url-tooltip {
            position: fixed;
            background-color: #1f2937;
            color: #ffffff;
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        
        /* Loading spinner CSS */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5; /* Indigo color for spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <script>
        // Expose your Firebase configuration to the game script
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCQ22h4DxNd8NQm1dyJpdh-sHADu70f3YQ",
            authDomain: "phish-or-not-project.firebaseapp.com",
            projectId: "phish-or-not-project",
            storageBucket: "phish-or-not-project.firebasestorage.app",
            messagingSenderId: "455143280251",
            appId: "1:455143280251:web:3d7dd344688b1c1c2edcde",
            measurementId: "G-CF68SPNSJM"
        });
        
        // Set your app identifier
        window.__app_id = "phishing-defense-game";
        
        console.log("Firebase configuration loaded:", window.__firebase_config);
    </script>

    <div id="game-container" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-4xl flex flex-col items-center justify-center transition-all duration-300 min-h-[90vh] md:min-h-[80vh] relative">
        
        <div class="absolute top-4 left-4 p-2">
            <svg class="h-8 w-8 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM12 4.09L19.98 8.44V15.56L12 19.91L4.02 15.56V8.44L12 4.09ZM12 7.5L8.5 9.5V14.5L12 16.5L15.5 14.5V9.5L12 7.5Z"/>
                <text x="12" y="15" font-family="Arial" font-size="8" font-weight="bold" text-anchor="middle" fill="#ffffff">I</text>
            </svg>
        </div>

        <div id="start-screen" class="p-8 text-center">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">Phishing Defense</h1>
            
            <div id="auth-status" class="flex flex-col items-center justify-center mb-6">
                <div id="loading-spinner" class="loader mb-2"></div>
                <p id="loading-message" class="text-gray-500">Checking connection...</p>
                <p id="user-info" class="text-xs text-gray-500 mt-2 hidden"></p>
            </div>

            <p id="game-status" class="text-center text-gray-600 mb-4">Enter your nickname to start.</p>
            <input type="text" id="nickname-input" placeholder="Your Nickname" class="w-full max-w-xs px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4 text-center">
            <button id="start-game-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300 disabled:opacity-50" disabled>
                Start Game
            </button>
        </div>
        
        <div id="game-view" class="w-full h-full flex flex-col p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <div id="player-nickname-header" class="text-lg font-semibold text-gray-700 hidden"></div>
                <button id="pause-quit-btn" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-lg hover:bg-gray-600 transition-colors duration-300 hidden">
                    Pause & Quit
                </button>
            </div>
            
            <div id="email-content" class="bg-white rounded-lg p-6 shadow-md border border-gray-200 flex-grow overflow-y-auto min-h-[500px] flex flex-col justify-center items-center">
                </div>
            
            <div id="score-display" class="mt-4 hidden">
                <div class="flex items-center justify-between text-gray-600 mb-1">
                    <span id="score-text" class="font-medium text-lg">Progress: 1/5</span>
                    <span id="player-score" class="font-bold text-gray-800 text-xl">0/5</span>
                </div>
            </div>
        </div>

        <div id="feedback-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 id="feedback-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
                <p id="feedback-message" class="text-gray-600 mb-6"></p>
                <button id="next-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Next Email
                </button>
            </div>
        </div>

        <div id="pause-quit-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Game Paused</h3>
                <p class="text-gray-600 mb-6">What would you like to do?</p>
                <div class="space-y-4">
                    <button id="resume-game-btn" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                        Resume Game
                    </button>
                    <button id="save-quit-btn" class="w-full px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-lg hover:bg-gray-600 transition-colors duration-300">
                        Save & Quit to Menu
                    </button>
                </div>
            </div>
        </div>

        <div id="end-game-popup" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Game Over!</h3>
                <p id="end-game-message" class="text-gray-600 text-lg mb-6"></p>
                <h4 class="text-xl font-semibold text-gray-800 mt-6 mb-4">Scores</h4>
                <ul id="leaderboard" class="space-y-3">
                    </ul>
                <button id="play-again-btn" class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Play More
                </button>
                <button id="quit-game-btn" class="mt-4 w-full px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-400 transition-colors duration-300">
                    That's it for now
                </button>
            </div>
        </div>
        
        <div id="thank-you-screen" class="p-8 text-center hidden">
            <h1 id="thank-you-title" class="text-5xl font-bold text-gray-800 mb-4"></h1>
            <p id="thank-you-message" class="text-xl text-gray-500 mb-8"></p>
            <button id="thank-you-play-again-btn" class="w-full max-w-xs px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                Play More
            </button>
        </div>
    </div>

    <div id="url-tooltip" class="hidden"></div>

    <script type="module">
        // --- Configuration Check ---
        console.log("Game loaded - Firebase will connect when user starts playing");
        
        // Check for required configuration variables
        const requiredVars = ['__firebase_config', '__app_id'];
        const missingVars = requiredVars.filter(varName => typeof window[varName] === 'undefined' || window[varName] === '');
        
        if (missingVars.length > 0) {
            console.warn(`Missing configuration variables: ${missingVars.join(', ')}`);
            console.log("Will run in offline mode when game starts");
            window.useOfflineMode = true;
        } else {
            console.log("Firebase configuration found - will connect when game starts");
            window.useOfflineMode = false;
        }
        
        // --- Startup Flow ---
        if (window.useOfflineMode) {
            initializeOfflineMode();
        } else {
            // Set initial loading state while Firebase connects
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-message').textContent = "Connecting to database...";
            
            // Immediately start the async Firebase initialization and sign-in
            (async () => {
                try {
                    await initializeFirebaseMode();
                    window.authInitialized = true;
                } catch (e) {
                    console.error("Fatal initialization error, switching to offline:", e);
                    window.useOfflineMode = true;
                    initializeOfflineMode();
                }
            })();
        }

        // --- UI Only Initialization (Not used for Firebase, but kept for offline fallback) ---
        function initializeUIOnly() {
            // Placeholder/Fallback function
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadingMessage = document.getElementById('loading-message');
            const userInfoEl = document.getElementById('user-info');
            const startGameBtn = document.getElementById('start-game-btn');

            loadingSpinner.classList.add('hidden');
            loadingMessage.textContent = "Ready to play! Enter your nickname to start.";
            loadingMessage.className = "text-indigo-600";
            userInfoEl.textContent = "Authentication will happen when you start playing";
            userInfoEl.classList.remove('hidden');
            startGameBtn.disabled = false;
        }

        // Simple offline nickname search using localStorage
        async function searchOfflineNicknames(searchTerm) {
            if (!searchTerm.trim()) return [];
            
            const savedData = localStorage.getItem('phishing-defense-data');
            if (!savedData) return [];
            
            try {
                const parsed = JSON.parse(savedData);
                const matches = [];
                const searchLower = searchTerm.toLowerCase().trim();
                
                if (parsed.name) {
                    const nameLower = parsed.name.toLowerCase();
                    if (nameLower === searchLower) {
                        matches.push({
                            nickname: parsed.name,
                            score: parsed.score || 0,
                            exact: true,
                            userId: 'local'
                        });
                    } else if (nameLower.includes(searchLower)) {
                        matches.push({
                            nickname: parsed.name,
                            score: parsed.score || 0,
                            exact: false,
                            userId: 'local'
                        });
                    }
                }
                
                return matches;
            } catch (e) {
                console.error("Error searching offline nicknames:", e);
                return [];
            }
        }
        
        // --- initializeFirebaseMode (Runs immediately on load) ---
        async function initializeFirebaseMode() {
            try {
                console.log("Loading Firebase modules...");
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { 
                    getAuth, 
                    signInAnonymously, 
                    signOut 
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { 
                    getFirestore, 
                    doc, 
                    getDoc, 
                    setDoc, 
                    onSnapshot, 
                    collection, 
                    getDocs
                } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                let db, auth;

                // Parse configuration
                let firebaseConfig;
                try {
                    firebaseConfig = JSON.parse(window.__firebase_config);
                } catch (e) {
                    throw new Error("Invalid Firebase Configuration");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // **CRITICAL: Expose core services**
                window.db = db;
                window.auth = auth; 
                window.loadPlayerDataByNickname = loadPlayerDataByNickname;
                window.searchNicknames = searchExistingNicknames;
                
                console.log("Firebase app initialized. Signing in visitor anonymously...");
                
                // **CRITICAL CHANGE 1: Sign in the visitor immediately on page load for read access**
                await signInAnonymously(auth); 
                
                // **CRITICAL CHANGE 2: Start the leaderboard listener immediately after sign-in**
                if (window.listenForScores) {
                    window.listenForScores(db);
                }

                // Update UI to show successful connection
                updateUI('firebase', auth.currentUser.uid);

                // Add logout functionality for page refresh
                window.addEventListener('beforeunload', () => {
                    if (auth && auth.currentUser) {
                        signOut(auth).catch(e => console.log("Logout error:", e));
                    }
                });


                // Firebase-specific functions
                async function loadPlayerDataByNickname(nickname, database) {
                    if (!database || !nickname) return null;
                    const appId = window.__app_id || 'default-app-id';
                    
                    try {
                        const playerDocRef = doc(database, `artifacts/${appId}/players`, nickname);
                        const playerDoc = await getDoc(playerDocRef);
                        
                        if (playerDoc.exists()) {
                            const data = playerDoc.data();
                            return {
                                nickname: nickname,
                                score: data.score || 0,
                                lastPlayed: data.lastPlayed,
                                gamesPlayed: data.gamesPlayed || 0
                            };
                        } else {
                            return null;
                        }
                    } catch (e) {
                        console.error("Error loading player data:", e);
                        return null;
                    }
                }

                async function searchExistingNicknames(searchTerm, database) {
                    if (!database || !searchTerm.trim()) return [];
                    
                    const appId = window.__app_id || 'default-app-id';
                    const playersColRef = collection(database, `artifacts/${appId}/players`);
                    
                    try {
                        const querySnapshot = await getDocs(playersColRef);
                        const matches = [];
                        const searchLower = searchTerm.toLowerCase().trim();
                        
                        querySnapshot.forEach((doc) => {
                            const nickname = doc.id;
                            const data = doc.data();
                            const nicknameLower = nickname.toLowerCase();
                            
                            if (nicknameLower.includes(searchLower)) {
                                matches.push({
                                    nickname: nickname,
                                    score: data.score || 0,
                                    exact: nicknameLower === searchLower,
                                    gamesPlayed: data.gamesPlayed || 0
                                });
                            }
                        });
                        
                        // Sort: exact matches first, then by score
                        matches.sort((a, b) => {
                            if (a.exact && !b.exact) return -1;
                            if (!a.exact && b.exact) return 1;
                            return b.score - a.score;
                        });
                        
                        return matches.slice(0, 5);
                    } catch (e) {
                        console.error("Error searching nicknames:", e);
                        // The user is authenticated, so if search fails, it's a database read error
                        // The initial anonymous sign-in should prevent this if rules are correct.
                        return [];
                    }
                }

                // Exposed globally to be called upon successful sign-in
                window.listenForScores = function(database) {
                    const appId = window.__app_id || 'default-app-id';
                    const playersColRef = collection(database, `artifacts/${appId}/players`);

                    onSnapshot(playersColRef, (snapshot) => {
                        const scores = [];
                        snapshot.forEach((doc) => {
                            const nickname = doc.id;
                            const data = doc.data();
                            scores.push({
                                id: nickname,
                                name: nickname,
                                score: data.score || 0,
                                gamesPlayed: data.gamesPlayed || 0
                            });
                        });
                        
                        scores.sort((a, b) => b.score - a.score);
                        gameState.leaderboardScores = scores;
                        
                        // Re-render the leaderboard if the End Game popup is currently visible
                        if (document.getElementById('end-game-popup').classList.contains('active-modal')) {
                            renderLeaderboard(scores);
                        }
                    }, (error) => {
                        console.error("Error listening to leaderboard (This is expected if rules are too strict, but should be fixed now):", error);
                    });
                }


                // Expose Firebase functions to global scope
                window.saveScore = async function() {
                    if (!gameState.player.name) return;
                    
                    const appId = window.__app_id || 'default-app-id';
                    const nickname = gameState.player.name;
                    const playerDocRef = doc(db, `artifacts/${appId}/players`, nickname);
                    
                    let currentGamesPlayed = 0;
                    try {
                        const currentDoc = await getDoc(playerDocRef);
                        if (currentDoc.exists()) {
                            currentGamesPlayed = currentDoc.data().gamesPlayed || 0;
                        }
                    } catch (e) {
                        console.log("No existing player data found.");
                    }

                    const playerData = {
                        score: gameState.score,
                        lastPlayed: new Date().toISOString(),
                        gamesPlayed: currentGamesPlayed + 1,
                        nickname: nickname
                    };

                    try {
                        // The user is already authenticated from the start, so this should work.
                        await setDoc(playerDocRef, playerData);
                    } catch (e) {
                        console.error("Error saving player data:", e);
                    }
                };

                // Expose logout function globally
                window.logoutUser = async function() {
                    if (auth && auth.currentUser) {
                        try {
                            // Visitor signs out of the anonymous session
                            await signOut(auth);
                            // Then the page is reloaded to sign them in again as a fresh visitor
                            location.reload(); 
                        } catch (e) {
                            console.error("Error signing out:", e);
                            resetToStartScreen();
                        }
                    }
                };

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                throw error; // Re-throw to be caught by the startup flow and switch to offline
            }
        }

        // --- Offline Mode ---
        function initializeOfflineMode() {
            console.log("Initializing offline mode");
            
            // Load from localStorage if available
            const savedData = localStorage.getItem('phishing-defense-data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    gameState.score = parsed.score || 0;
                    gameState.player.name = parsed.name || "";
                    gameState.leaderboardScores = parsed.leaderboard || [];
                } catch (e) {
                    console.error("Error parsing saved data:", e);
                }
            }

            // Mock save/logout functions... (rest of offline mode functions remain)
            window.saveScore = async function() {
                const dataToSave = {
                    score: gameState.score,
                    name: gameState.player.name,
                    leaderboard: gameState.leaderboardScores,
                    lastPlayed: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem('phishing-defense-data', JSON.stringify(dataToSave));
                    const existingPlayerIndex = gameState.leaderboardScores.findIndex(p => p.name === gameState.player.name);
                    if (existingPlayerIndex >= 0) {
                        gameState.leaderboardScores[existingPlayerIndex].score = gameState.score;
                    } else {
                        gameState.leaderboardScores.push({
                            id: 'local-' + Date.now(),
                            name: gameState.player.name,
                            score: gameState.score
                        });
                    }
                    gameState.leaderboardScores.sort((a, b) => b.score - a.score);
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                }
            };

            window.logoutUser = async function() {
                resetToStartScreen();
            };

            updateUI('offline');
        }

        // --- UI Update Function ---
        function updateUI(mode, userId = null) {
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadingMessage = document.getElementById('loading-message');
            const userInfoEl = document.getElementById('user-info');
            const startGameBtn = document.getElementById('start-game-btn');

            loadingSpinner.classList.add('hidden');
            
            if (mode === 'firebase') {
                loadingMessage.textContent = "Connected! Smart search and leaderboards active.";
                loadingMessage.className = "text-green-600";
                userInfoEl.textContent = `Visitor ID: ${userId ? userId.substring(0, 8) + '...' : 'N/A'}`;
                userInfoEl.classList.remove('hidden');
            } else {
                loadingMessage.textContent = "Playing offline - scores saved locally.";
                loadingMessage.className = "text-yellow-600";
                userInfoEl.textContent = "Offline Mode";
                userInfoEl.classList.remove('hidden');
            }
            
            startGameBtn.disabled = false;
        }

        // --- Game State & Game Logic (NO CHANGES BELOW THIS LINE) ---
        const gameState = {
            currentEmail: null,
            score: 0,
            sessionScore: 0,
            currentEmailIndex: 0,
            emails: [],
            player: { name: "Player" },
            leaderboardScores: [],
            
            scenarios: [
                {
                    id: 1,
                    sender: "Netflix Support <noreply@netflix-update.co>",
                    subject: "Your Netflix account has been suspended",
                    body: "We have temporarily suspended your account due to an issue with your billing information. Please click the link below to verify your details and reactivate your account. <br><br> <a href='http://netflix-login.info/update' class='text-indigo-600 hover:underline'>Click here to update your account</a>",
                    isPhishing: true,
                    redFlags: ["Sender's email domain (@netflix-update.co) is incorrect.","Urgent and threatening language is a common tactic.","The link points to a non-Netflix URL."]
                },
                {
                    id: 2,
                    sender: "Amazon <security@amazon.com>",
                    subject: "Order Confirmation: Your recent purchase",
                    body: "Dear [User Name], <br><br> Thank you for your recent purchase. Your order #113-456789-012345 has been confirmed and will be shipped shortly. You can track your order here: <a href='https://amazon.com/tracking' class='text-indigo-600 hover:underline'>Track Package</a>. <br><br> Sincerely, <br>The Amazon Team",
                    isPhishing: false,
                    redFlags: ["Sender's domain is correct.","No sense of urgency or threat.","Link points to the correct domain."]
                },
                {
                    id: 3,
                    sender: "HR Department <HR-announcements@innovatech-internal.com>",
                    subject: "Mandatory System Update",
                    body: "All employees must update their system credentials via the link below to comply with new security protocols. Failure to do so will result in a temporary suspension of access. <br><br> <a href='http://credentials-update.co/login' class='text-indigo-600 hover:underline'>Update Credentials Now</a>",
                    isPhishing: true,
                    redFlags: ["Urgent, high-pressure language to create panic.","The email asks for credentials, which a legitimate IT department would not do.","The email domain is incorrect (it should be @innovatech.com)."]
                },
                {
                    id: 4,
                    sender: "IT Support <support@innovatech.com>",
                    subject: "New IT Portal for Support Requests",
                    body: "Hi team, <br><br> We are rolling out a new IT support portal to streamline requests. You can now submit tickets directly at our new portal. Please bookmark the link for future use: <br><br> <a href='https://portal.innovatech.com' class='text-indigo-600 hover:underline'>https://portal.innovatech.com</a>",
                    isPhishing: false,
                    redFlags: ["Sender's email and tone are appropriate for an internal notice.","The link points to a plausible internal sub-domain.","No sudden urgent requests for sensitive data."]
                },
                {
                    id: 5,
                    sender: "Accounts Payable <payments@invoicesystem.co>",
                    subject: "URGENT Invoice from Supplier",
                    body: "Attached is an invoice for a recent order. Please transfer payment within 24 hours to the new bank account number listed in the attached document to avoid late fees. <br><br> Attachment: <a href='http://invoicesystem.com/payment' class='text-indigo-600 hover:underline'>Invoice_#3459.pdf</a>",
                    isPhishing: true,
                    redFlags: ["Extreme urgency and pressure for financial action.","Request to change payment details unexpectedly.","Sender's email address is from a generic, suspicious domain."]
                }
            ],
        };

        function resetToStartScreen() {
            // Reset UI to start screen
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('end-game-popup').classList.remove('active-modal');
            document.getElementById('end-game-popup').classList.add('hidden');
            document.getElementById('feedback-popup').classList.remove('active-modal');
            document.getElementById('feedback-popup').classList.add('hidden');
            document.getElementById('pause-quit-popup').classList.add('hidden');
            document.getElementById('thank-you-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            
            // Reset game state
            gameState.currentEmailIndex = 0;
            gameState.sessionScore = 0;
            gameState.player.name = "";
            
            // Reset form
            document.getElementById('nickname-input').value = "";
            document.getElementById('game-status').textContent = "Enter your nickname to start.";
            
            // Reset button state
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = false;
            startBtn.textContent = "Start Game";
            
            // Remove nickname suggestions if any
            const suggestions = document.getElementById('nickname-suggestions');
            if (suggestions) suggestions.remove();
        }

        function pauseGame() {
            document.getElementById('pause-quit-popup').classList.remove('hidden');
        }

        function resumeGame() {
            document.getElementById('pause-quit-popup').classList.add('hidden');
        }

        async function saveAndQuit() {
            // Save current progress
            if (gameState.sessionScore > 0) {
                gameState.score += gameState.sessionScore;
                if (window.saveScore) {
                    await window.saveScore();
                }
            }
            
            document.getElementById('pause-quit-popup').classList.add('hidden');
            
            // NEW: Sign out the temporary anonymous user (resets session)
            if (window.logoutUser) {
                await window.logoutUser();
            } else {
                // If offline mode, or logout failed, just reset UI
                resetToStartScreen();
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Set up nickname input event listeners
        function setupNicknameInput() {
            const nicknameInput = document.getElementById('nickname-input');
            let searchTimeout;
            
            nicknameInput.addEventListener('input', async (e) => {
                const value = e.target.value.trim();
                
                // Clear existing suggestions
                const existing = document.getElementById('nickname-suggestions');
                if (existing) existing.remove();
                
                if (value.length < 2) return;
                
                // Use available search function (offline initially, then Firebase after auth)
                if (window.searchNicknames) {
                    // Debounce search
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(async () => {
                        // The searchNicknames function now works because the visitor is already signed in
                        const suggestions = await window.searchNicknames(value, window.db || null);
                        if (suggestions.length > 0) {
                            showNicknameSuggestions(suggestions, value);
                        }
                    }, 300);
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!nicknameInput.contains(e.target)) {
                    const suggestions = document.getElementById('nickname-suggestions');
                    if (suggestions) suggestions.remove();
                }
            });
            
            // Hide suggestions on escape key
            nicknameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const suggestions = document.getElementById('nickname-suggestions');
                    if (suggestions) suggestions.remove();
                }
            });
        }

        async function startGame() {
            const nickname = document.getElementById('nickname-input').value.trim();
            if (nickname === "") {
                document.getElementById('game-status').textContent = "Please enter a nickname to start.";
                return;
            }

            // Validate nickname for Firestore compatibility
            const validNicknamePattern = /^[a-zA-Z0-9._-]+$/;
            if (!validNicknamePattern.test(nickname)) {
                document.getElementById('game-status').textContent = "Nickname can only contain letters, numbers, dots, underscores, and hyphens.";
                return;
            }

            // Remove any remaining suggestions
            const suggestions = document.getElementById('nickname-suggestions');
            if (suggestions) suggestions.remove();
            
            // Show loading state
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = true;
            startBtn.textContent = "Loading...";

            // 1. Check readiness (User is ALREADY authenticated by initializeFirebaseMode)
            if (window.useOfflineMode) {
                // Offline mode data loading
                gameState.player.name = nickname;
                const savedData = localStorage.getItem('phishing-defense-data');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.name === nickname) {
                            gameState.score = parsed.score || 0;
                        }
                    } catch (e) {
                        console.error("Error loading offline data:", e);
                    }
                }
            } 
            else if (window.db && window.auth && window.auth.currentUser) {
                // Firebase mode: Load player data using the existing authenticated session
                try {
                    const playerData = await window.loadPlayerDataByNickname(nickname, window.db);
                    if (playerData) {
                        gameState.player.name = playerData.nickname;
                        gameState.score = playerData.score;
                    } else {
                        gameState.player.name = nickname;
                        gameState.score = 0;
                    }
                    
                } catch (e) {
                    console.error("Error loading player profile:", e);
                    document.getElementById('game-status').textContent = "Error loading profile. Check console for details.";
                    startBtn.disabled = false;
                    startBtn.textContent = "Start Game";
                    return;
                }
            } else {
                console.error("System not ready or configuration error.");
                document.getElementById('game-status').textContent = "System not ready. Try refreshing.";
                startBtn.disabled = false;
                startBtn.textContent = "Start Game";
                return;
            }
            
            // Reset button state
            startBtn.disabled = false;
            startBtn.textContent = "Start Game";
            
            document.getElementById('player-nickname-header').textContent = `Hello, ${gameState.player.name}! Defend the inbox.`;
            document.getElementById('player-nickname-header').classList.remove('hidden');
            document.getElementById('pause-quit-btn').classList.remove('hidden');

            gameState.sessionScore = 0;
            gameState.currentEmailIndex = 0;
            gameState.emails = shuffleArray(gameState.scenarios);

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('thank-you-screen').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('score-display').classList.remove('hidden');
            
            renderEmail(gameState.emails[gameState.currentEmailIndex]);
            updateSessionScoreDisplay();
        }

        function showNicknameSuggestions(suggestions, inputValue) {
            // Remove existing suggestions
            const existing = document.getElementById('nickname-suggestions');
            if (existing) existing.remove();
            
            if (suggestions.length === 0) return;
            
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.id = 'nickname-suggestions';
            suggestionsDiv.className = 'absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto';
            
            suggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                suggestionItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${suggestion.nickname}</span>
                        <span class="text-sm text-gray-500">Score: ${suggestion.score}</span>
                    </div>
                    <div class="text-xs text-gray-400">${suggestion.exact ? 'Exact match - click to use this profile' : 'Similar nickname'}</div>
                `;
                
                suggestionItem.addEventListener('click', () => {
                    document.getElementById('nickname-input').value = suggestion.nickname;
                    suggestionsDiv.remove();
                    
                    // Update game status for returning user
                    if (suggestion.exact) {
                        document.getElementById('game-status').innerHTML = `Found existing profile: <strong>${suggestion.nickname}</strong> (Score: ${suggestion.score}). Click Start Game to continue.`;
                    }
                });
                
                suggestionsDiv.appendChild(suggestionItem);
            });
            
            // Position suggestions relative to input
            const inputContainer = document.getElementById('nickname-input').parentElement;
            inputContainer.style.position = 'relative';
            inputContainer.appendChild(suggestionsDiv);
        }

        function renderEmail(email) {
            const emailContent = document.getElementById('email-content');
            emailContent.classList.remove('justify-center', 'items-center');

            const escapedSender = email.sender
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            emailContent.innerHTML = `
                <div class="mb-4 overflow-x-auto">
                    <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-1">${email.subject}</h2>
                    <p class="text-gray-500 text-sm">From: <span class="font-medium text-gray-700">${escapedSender}</span></p>
                </div>
                <div class="prose max-w-none text-gray-700 mb-6">
                    ${email.body}
                </div>
                <div id="action-buttons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full">
                    <button id="safe-btn" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-colors duration-300">
                        ✓ Safe
                    </button>
                    <button id="phish-btn" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-lg hover:bg-red-600 transition-colors duration-300">
                        ⚠ Spam
                    </button>
                </div>
            `;

            document.getElementById('safe-btn').addEventListener('click', () => handleAnswer(false, email));
            document.getElementById('phish-btn').addEventListener('click', () => handleAnswer(true, email));
            
            const links = emailContent.querySelectorAll('a');
            const urlTooltip = document.getElementById('url-tooltip');
            
            links.forEach(link => {
                link.addEventListener('mouseover', (e) => {
                    const href = e.target.getAttribute('href');
                    if (href) {
                        urlTooltip.textContent = href;
                        urlTooltip.style.top = `${e.clientY + 15}px`;
                        urlTooltip.style.left = `${e.clientX + 15}px`;
                        urlTooltip.classList.remove('hidden');
                    }
                });
                link.addEventListener('mouseout', () => {
                    urlTooltip.classList.add('hidden');
                });
            });
        }

        function handleAnswer(isUserPhish, email) {
            const isCorrect = (isUserPhish === email.isPhishing);
            const scoreChange = isCorrect ? 1 : 0;
            
            gameState.sessionScore += scoreChange;
            updateSessionScoreDisplay();
            showFeedback(isCorrect, email);

            document.getElementById('safe-btn').disabled = true;
            document.getElementById('phish-btn').disabled = true;
        }

        function showFeedback(isCorrect, email) {
            const title = isCorrect ? "Correct!" : "Oops, Not Quite.";
            let message = "";
            const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;

            if (isCorrect) {
                message = email.isPhishing
                    ? `<strong>Great job!</strong> You correctly spotted the scam.`
                    : `<strong>Excellent!</strong> This was a safe and legitimate message.`;
            } else {
                message = email.isPhishing
                    ? "This was a phishing email. You should have reported it."
                    : "This was a safe email. Not every urgent email is a scam!";
                
                message += "<div class='text-left mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-700'><h4 class='font-bold mb-2'>Analysis:</h4><ul class='list-disc list-inside space-y-1'>" + email.redFlags.map(flag => `<li>${flag}</li>`).join('') + "</ul></div>";
            }

            document.getElementById('next-btn').textContent = isLastEmail ? "View Final Score" : "Next Email";
            document.getElementById('feedback-title').textContent = title;
            document.getElementById('feedback-message').innerHTML = message;
            document.getElementById('feedback-popup').classList.add('active-modal');
            document.getElementById('feedback-popup').classList.remove('hidden');
        }

        function nextEmail() {
            document.getElementById('feedback-popup').classList.remove('active-modal');
            document.getElementById('feedback-popup').classList.add('hidden');
            gameState.currentEmailIndex++;
            
            if (gameState.currentEmailIndex < gameState.emails.length) {
                renderEmail(gameState.emails[gameState.currentEmailIndex]);
                updateSessionScoreDisplay();
            } else {
                endGame();
            }
        }
        
        async function endGame() {
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('end-game-popup').classList.add('active-modal');
            document.getElementById('end-game-popup').classList.remove('hidden');
            
            gameState.score += gameState.sessionScore;
            
            if (window.saveScore) {
                await window.saveScore();
            }
            
            // --- FIX START ---
            // Add a small delay for Firebase mode to ensure the onSnapshot listener 
            // receives the updated score before we attempt to render the leaderboard.
            if (!window.useOfflineMode) {
                 await new Promise(resolve => setTimeout(resolve, 600)); // 600ms buffer
            }
            // --- FIX END ---

            const sessionScore = gameState.sessionScore;
            const totalEmails = gameState.emails.length;
            
            let finalMessage = "";
            if (sessionScore === totalEmails) {
                finalMessage = `Perfect defense, ${gameState.player.name}!`;
            } else if (sessionScore >= totalEmails * 0.8) {
                finalMessage = `Strong defense, ${gameState.player.name}!`;
            } else {
                finalMessage = `Good effort, ${gameState.player.name}!`;
            }

            document.getElementById('end-game-message').innerHTML = finalMessage;
            // The score is now guaranteed (or highly likely) to be updated in gameState.leaderboardScores
            renderLeaderboard(gameState.leaderboardScores);
        }

        function showThankYouScreen() {
            document.getElementById('end-game-popup').classList.remove('active-modal');
            document.getElementById('end-game-popup').classList.add('hidden');
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('thank-you-screen').classList.remove('hidden');

            const score = gameState.score;
            const name = gameState.player.name;
            let title = `Thanks for Playing, ${name}!`;
            let message = `Your total career score is <strong>${score}</strong>. Keep building that defense!`;

            if (score > 15) {
                title = `Cybersecurity Champion, ${name}!`;
            } else if (score > 5) {
                title = `Well Done, ${name}!`;
            }

            document.getElementById('thank-you-title').textContent = title;
            document.getElementById('thank-you-message').innerHTML = message;
        }
        
        function updateSessionScoreDisplay() {
            const totalEmails = gameState.emails.length;
            const currentEmailNumber = gameState.currentEmailIndex + 1;
            
            document.getElementById('score-text').textContent = `Email ${currentEmailNumber} of ${totalEmails}`;
            document.getElementById('player-score').textContent = `${gameState.sessionScore} / ${totalEmails}`;
        }

        function renderLeaderboard(scores) {
            const scoresListEl = document.getElementById('leaderboard');
            scoresListEl.innerHTML = '';
            
            if (scores.length === 0) {
                scoresListEl.innerHTML = '<li class="text-gray-500">No scores yet. Be the first!</li>';
                return;
            }

            scores.slice(0, 10).forEach(item => {
                const isPlayer = item.name === gameState.player.name;
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between items-center text-gray-700 px-4 py-2 rounded-lg ${isPlayer ? 'bg-indigo-100 font-semibold border-2 border-indigo-400' : ''}`;
                listItem.innerHTML = `
                    <span class="truncate">${item.name} ${isPlayer ? '(You)' : ''}</span>
                    <span class="font-bold text-lg">${item.score}</span>
                `;
                scoresListEl.appendChild(listItem);
            });
        }
        
        // --- Event Listeners ---
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('pause-quit-btn').addEventListener('click', pauseGame);
        document.getElementById('resume-game-btn').addEventListener('click', resumeGame);
        document.getElementById('save-quit-btn').addEventListener('click', saveAndQuit);

        document.getElementById('next-btn').addEventListener('click', () => {
             const isLastEmail = gameState.currentEmailIndex === gameState.emails.length - 1;
             if (isLastEmail) {
                document.getElementById('feedback-popup').classList.remove('active-modal');
                document.getElementById('feedback-popup').classList.add('hidden');
                endGame();
             } else {
                nextEmail(); 
             }
        });

        document.getElementById('play-again-btn').addEventListener('click', () => {
            document.getElementById('end-game-popup').classList.remove('active-modal');
            document.getElementById('end-game-popup').classList.add('hidden');
            startGame();
        });
        
        document.getElementById('quit-game-btn').addEventListener('click', showThankYouScreen);
        
        document.getElementById('thank-you-play-again-btn').addEventListener('click', () => {
            startGame();
        });

        // Initialize nickname input functionality
        setupNicknameInput();

    </script>
</body>
</html>